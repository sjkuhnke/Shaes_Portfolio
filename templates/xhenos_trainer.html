{% load static %}
{% load pokemon_extras %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>{{ trainer_name }} - Trainer Database</title>
  <meta name="description" content="View battle history and team compositions for {{ trainer_name }} in Pokémon Xhenos.">

  <link rel="shortcut icon" href="{% static 'images/logo.ico' %}" type="image/x-icon">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>

<main>
  <article>
    <a href="/xhenos/trainers/" class="back-button">
      <i class="fas fa-arrow-left"></i> Back to Database
    </a>

    <!-- Trainer Hero -->
    <div class="trainer-hero">
      <div class="trainer-header">
        <div class="trainer-avatar">
          <i class="fas fa-user-ninja"></i>
        </div>
        <div class="trainer-details">
          <h1>{{ trainer_name }}</h1>
          <div class="trainer-meta">
            <span class="meta-item">
              <i class="fas fa-trophy"></i>
              Trainer
            </span>
            <span class="meta-item">
              <i class="fas fa-history"></i>
              {{ battles|length }} Battle{{ battles|length|pluralize }} Recorded
            </span>
          </div>
        </div>
      </div>
    </div>

    {% if battles %}
    <!-- Stats Overview -->
    <section class="stats-overview">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-burst"></i></div>
          <div class="stat-label">Total Battles</div>
          <div class="stat-value">{{ battles|length }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-users"></i></div>
          <div class="stat-label">Unique Pokémon Used</div>
          <div class="stat-value" id="unique-pokemon">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-star"></i></div>
          <div class="stat-label">Average Team Level</div>
          <div class="stat-value" id="avg-level">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-shield-alt"></i></div>
          <div class="stat-label">Most Used Pokémon</div>
          <div class="stat-value" id="most-used" style="font-size: 1.2rem;">-</div>
        </div>
      </div>
    </section>

    <!-- Battles List -->
    <section class="battles-section">
      <h2><i class="fas fa-history"></i> Battle History</h2>

      {% for battle in battles %}
      <div class="battle-card" data-battle-id="{{ battle.id }}">
        <div class="battle-header">
          <div class="battle-info">
            <span class="battle-detail">
              <i class="fas fa-user"></i> {{ battle.player_name }}
            </span>
            <span class="battle-detail">
              <i class="fas fa-gamepad"></i> {{ battle.game_version }}
            </span>
            <span class="battle-detail">
              <i class="fas fa-clock"></i> {{ battle.battle_start_datetime|date:"M d, Y" }}
            </span>
            <span class="battle-detail">
              <i class="fas fa-users"></i> {{ battle.team.count }} Pokémon
            </span>
            {% if battle.victory %}
            <span class="battle-detail victory-badge">
              <i class="fas fa-trophy"></i> Victory
            </span>
            {% endif %}
          
            {% if battle.difficulty|as_int == 1 %}
            <span class="battle-detail difficulty-badge difficulty-normal">
              <i class="fas fa-circle"></i> Normal
            </span>
            {% elif battle.difficulty|as_int == 3 %}
            <span class="battle-detail difficulty-badge difficulty-extreme">
              <i class="fas fa-skull"></i> Extreme
            </span>
            {% else %}
            <span class="battle-detail difficulty-badge difficulty-hard">
              <i class="fas fa-fire"></i> Hard
            </span>
            {% endif %}
          </div>
        
          <button class="expand-btn" onclick="toggleTeam({{ battle.id }})">
            <i class="fas fa-chevron-down"></i>
            <span>View Team</span>
          </button>
        </div>

        <div class="pokemon-team" id="team-{{ battle.id }}">
          {% for pokemon in battle.team.all %}
          {{ pokemon.moveset_details|json_script }}
          <div class="pokemon-card{% if pokemon.fainted %} fainted{% endif %}{% if pokemon.died %} died{% endif %}" data-moves-id="moves-{{ battle.id }}-{{ forloop.counter0 }}">
          
            <!-- Pokemon Badges -->
            {% if pokemon.total_turns > 0 %}
            <div class="pokemon-badges">
              {% if pokemon.is_lead and not pokemon.is_benched %}
              <div class="pokemon-badge badge-lead" title="Selected as lead">
                <i class="fas fa-flag"></i>
                <span>Lead</span>
              </div>
              {% endif %}
              {% if pokemon.is_mvp %}
              <div class="pokemon-badge badge-mvp" title="Highest battle participation">
                <i class="fas fa-crown"></i>
                <span>MVP</span>
              </div>
              {% endif %}
              {% if pokemon.is_damage_dealer %}
              <div class="pokemon-badge badge-damage-dealer" title="Highest damage dealt ({{ pokemon.damage_dealt|floatformat:1 }}%)">
                <i class="fas fa-fire"></i>
                <span>Carry</span>
              </div>
              {% endif %}
              {% if pokemon.is_tank %}
              <div class="pokemon-badge badge-tank" title="Absorbed {{ pokemon.damage_taken|floatformat:1 }}% damage">
                <i class="fas fa-shield"></i>
                <span>Tank</span>
              </div>
              {% endif %}
              {% if pokemon.is_pivot %}
              <div class="pokemon-badge badge-pivot" title="Frequently switched in ({{ pokemon.switch_ins }}+ times)">
                <i class="fas fa-arrows-rotate"></i>
                <span>Pivot</span>
              </div>
              {% endif %}
              {% if pokemon.is_benched %}
              <div class="pokemon-badge badge-benched" title="Did not participate in battle">
                <i class="fas fa-chair"></i>
                <span>Benched</span>
              </div>
              {% endif %}
            </div>
            {% endif %}

            <div class="pokemon-header">
              <div class="pokemon-name">
                {{ pokemon.name }}
                {% if pokemon.shiny %}<i class="fas fa-sparkles shiny-indicator"></i>{% endif %}
                {% if pokemon.nickname and pokemon.nickname != pokemon.name %}
                  <div style="color: var(--light-gray-70); font-size: 0.85rem;">"{{ pokemon.nickname }}"</div>
                {% endif %}
              </div>
              <div class="pokemon-level">Lv {{ pokemon.level }}</div>
            </div>
        
            <div class="pokemon-types">
              <span class="type-badge type-{{ pokemon.type1|lower }}">{{ pokemon.type1 }}</span>
              {% if pokemon.type2 %}
              <span class="type-badge type-{{ pokemon.type2|lower }}">{{ pokemon.type2 }}</span>
              {% endif %}
            </div>
            
            <!-- Battle Stats Section -->
            <div class="battle-stats-section">
              {% if pokemon.kills > 0 %}
              <div class="battle-stat kills">
                <i class="fas fa-skull-crossbones"></i>
                <span class="stat-number">{{ pokemon.kills }}</span>
                <span class="stat-text">Kill{{ pokemon.kills|pluralize }}</span>
              </div>
              {% endif %}
              {% if pokemon.died %}
              <div class="battle-stat death">
                <i class="fas fa-heart-broken"></i>
                <span class="stat-text">Died</span>
              </div>
              {% endif %}
              {% if pokemon.evolved %}
              <div class="battle-stat evolution">
                <i class="fas fa-arrow-up"></i>
                <span class="stat-text">Evolved</span>
              </div>
              {% endif %}
            </div>
            
            <div class="pokemon-stats">
              <div class="pokemon-stat">
                <span class="pokemon-stat-label">HP</span>
                <span class="pokemon-stat-value">{{ pokemon.current_hp }}/{{ pokemon.max_hp }}</span>
              </div>
              <div class="pokemon-stat">
                <span class="pokemon-stat-label">Ability</span>
                <span class="pokemon-stat-value ability-value">{{ pokemon.ability }}</span>
              </div>
              <div class="pokemon-stat">
                <span class="pokemon-stat-label">Nature</span>
                <span class="pokemon-stat-value">{{ pokemon.nature }}</span>
              </div>
              {% if pokemon.item %}
              <div class="pokemon-stat">
                <span class="pokemon-stat-label">Item</span>
                <span class="pokemon-stat-value">{{ pokemon.item }}</span>
              </div>
              {% endif %}
            </div>
            
            {% if pokemon.moveset %}
            <div class="pokemon-moves">
              <div class="moves-label">Moveset</div>
              <div class="move-list">
                {% for move in pokemon.moveset %}
                <span class="move-badge{% if pokemon.pp_used and move in pokemon.pp_used %} move-used{% endif %}"
                      data-pp-used="{% if pokemon.pp_used and move in pokemon.pp_used %}{{ pokemon.pp_used|get_item:move }}{% endif %}">
                  {{ move }}
                  {% if pokemon.pp_used and move in pokemon.pp_used %}
                  <span class="pp-indicator">{{ pokemon.pp_used|get_item:move }}</span>
                  {% endif %}
                </span>
                {% endfor %}
              </div>
            </div>
            {% endif %}
        
            <div class="performance-meters">
              <div class="performance-meter">
                <div class="meter-label">
                  <span>Damage Dealt</span>
                  <span class="meter-value damage-dealt-value">{{ pokemon.damage_dealt|floatformat:1 }}%</span>
                </div>
                <div class="meter-bar">
                  <div class="meter-fill damage-dealt-fill" style="width: min({{ pokemon.damage_dealt }}%, 100%)"></div>
                </div>
              </div>
        
              <div class="performance-meter">
                <div class="meter-label">
                  <span>Damage Taken</span>
                  <span class="meter-value damage-taken-value">{{ pokemon.damage_taken|floatformat:1 }}%</span>
                </div>
                <div class="meter-bar">
                  <div class="meter-fill damage-taken-fill" style="width: min({{ pokemon.damage_taken }}%, 100%)"></div>
                </div>
              </div>
            </div>
            
            <!-- TOOLTIP -->
            <div class="pokemon-tooltip">
              <!-- Stats Section -->
              <div class="tooltip-section">
                <div class="tooltip-header">
                  <i class="fas fa-chart-bar"></i> Base Stats & IVs
                </div>
                <div class="tooltip-content">
                  {% for stat, iv in pokemon.stats|zip:pokemon.ivs %}
                  <div class="stat-row">
                    <span class="stat-name">{{ forloop.counter0|stat_name }}</span>
                    <div class="stat-values">
                      <span class="stat-base">{{ stat }}</span>
                      <span class="stat-iv">IV: {{ iv }}</span>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </div>
            
              <!-- Battle Participation Section (NEW) -->
              {% if pokemon.turns is not None and pokemon.switch_ins is not None %}
              <div class="tooltip-section">
                <div class="tooltip-header">
                  <i class="fas fa-chart-line"></i> Battle Participation
                </div>
                <div class="tooltip-content">
                  <div class="info-row">
                    <span class="info-label">
                      <i class="fas fa-play"></i> Turns Active
                    </span>
                    <span class="info-value">
                      {{ pokemon.turns }} / {{ pokemon.total_turns }} ({{ pokemon.turn_percentage }}%)
                    </span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">
                      <i class="fas fa-arrows-rotate"></i> Switch-ins
                    </span>
                    <span class="info-value">{{ pokemon.switch_ins }}</span>
                  </div>
                </div>
              </div>
              {% endif %}
            
              <!-- Battle Performance Section -->
              {% if pokemon.kills or pokemon.died or pokemon.evolved %}
              <div class="tooltip-section">
                <div class="tooltip-header">
                  <i class="fas fa-fire"></i> Battle Performance
                </div>
                <div class="tooltip-content">
                  {% if pokemon.kills > 0 %}
                  <div class="info-row">
                    <span class="info-label">
                      <i class="fas fa-skull-crossbones"></i> Total Kills
                    </span>
                    <span class="info-value kills-count">{{ pokemon.kills }}</span>
                  </div>
                  {% if pokemon.kill_list %}
                  <div class="kill-list-section">
                    <div class="kill-list-label">Defeated:</div>
                    {% for kill in pokemon.kill_list %}
                    <div class="kill-item">{{ kill }}</div>
                    {% endfor %}
                  </div>
                  {% endif %}
                  {% endif %}
                    
                  {% if pokemon.died %}
                  <div class="info-row death-info">
                    <span class="info-label">
                      <i class="fas fa-heart-broken"></i> Fainted
                    </span>
                    {% if pokemon.killer %}
                    <span class="info-value killer-name">by {{ pokemon.killer }}</span>
                    {% else %}
                    <span class="info-value">Yes</span>
                    {% endif %}
                  </div>
                  {% endif %}
                    
                  {% if pokemon.evolved %}
                  <div class="info-row evolution-info">
                    <span class="info-label">
                      <i class="fas fa-arrow-up"></i> Evolved Into
                    </span>
                    <span class="info-value">{{ pokemon.evo_name|default:"Unknown" }}</span>
                  </div>
                  {% endif %}
                </div>
              </div>
              {% endif %}
            
              <!-- Additional Info Section -->
              <div class="tooltip-section">
                <div class="tooltip-header">
                  <i class="fas fa-info-circle"></i> Additional Info
                </div>
                <div class="tooltip-content">
                  <div class="info-row">
                    <span class="info-label">Status</span>
                    <span class="status-badge status-{{ pokemon.status|lower }}">{{ pokemon.status }}</span>
                  </div>
                  {% if pokemon.met_at %}
                  <div class="info-row met-location-row">
                    <span class="info-label">
                      <i class="fas fa-map-marker-alt"></i> Met At
                    </span>
                    <span class="info-value met-location">{{ pokemon.met_at }}</span>
                  </div>
                  {% endif %}
                  {% if pokemon.ball %}
                  <div class="info-row">
                    <span class="info-label">Poké Ball</span>
                    <span class="ball-display">
                      <span class="ball-icon"></span>
                      {{ pokemon.ball }}
                    </span>
                  </div>
                  {% endif %}
                  <div class="info-row">
                    <span class="info-label">Ability Slot</span>
                    <span class="info-value">Slot {{ pokemon.ability_slot }}</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Pokémon ID</span>
                    <span class="info-value">#{{ pokemon.pokemon_id }}</span>
                  </div>
                </div>
              </div>
          
              <!-- Happiness Section -->
              <div class="tooltip-section">
                <div class="tooltip-header">
                  <i class="fas fa-heart"></i> Happiness
                </div>
                <div class="happiness-bar">
                  <div class="happiness-fill" style="width: {{ pokemon.happiness|multiply:0.392 }}%"></div>
                </div>
                <div class="happiness-text">
                  <span>{{ pokemon.happiness }}/255</span>
                  <span>{{ pokemon.happiness|multiply:0.392|floatformat:0 }}%</span>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    </section>
    {% else %}
    <div class="no-battles">
      <i class="fas fa-inbox"></i>
      <h3>No Battle History Found</h3>
      <p>No battles have been recorded for {{ trainer_name }} yet.</p>
    </div>
  {% endif %}
  <div id="tooltip-layer"></div>
</article>
</main>

<script>
function toggleTeam(battleId) {
  const team = document.getElementById(`team-${battleId}`);
  const btn = team.previousElementSibling.querySelector('.expand-btn');
  const icon = btn.querySelector('i');
  const text = btn.querySelector('span');

  team.classList.toggle('expanded');

  if (team.classList.contains('expanded')) {
    icon.className = 'fas fa-chevron-up';
    text.textContent = 'Hide Team';
  } else {
    icon.className = 'fas fa-chevron-down';
    text.textContent = 'View Team';
  }
}

// Calculate statistics
document.addEventListener('DOMContentLoaded', function() {
  const battles = document.querySelectorAll('.battle-card');
  const uniquePokemon = new Set();
  let totalLevel = 0;
  let totalPokemon = 0;
  const pokemonCount = {};

  battles.forEach(battle => {
    const pokemonCards = battle.querySelectorAll('.pokemon-card');
    pokemonCards.forEach(card => {
      const name = card.querySelector('.pokemon-name').textContent.trim().split('\n')[0].trim();
      const level = parseInt(card.querySelector('.pokemon-level').textContent.replace('Lv ', ''));

      uniquePokemon.add(name);
      totalLevel += level;
      totalPokemon++;

      pokemonCount[name] = (pokemonCount[name] || 0) + 1;
    });
  });

  // Update stats
  document.getElementById('unique-pokemon').textContent = uniquePokemon.size;
  document.getElementById('avg-level').textContent = totalPokemon > 0
    ? Math.round(totalLevel / totalPokemon)
    : 0;

  // Find most used Pokemon
  let mostUsed = '';
  let maxCount = 0;
  for (const [pokemon, count] of Object.entries(pokemonCount)) {
    if (count > maxCount) {
      maxCount = count;
      mostUsed = pokemon;
    }
  }
  document.getElementById('most-used').textContent = mostUsed || 'N/A';
  
  setupMoveTooltips();
  enhancePokemonTooltips();
});

const MOVE_CATEGORY_MAP = {
  0: 'Physical',
  1: 'Special',
  2: 'Status'
};

function setupMoveTooltips() {
    document.querySelectorAll('.pokemon-card').forEach(card => {
       const movesID = card.getAttribute('data-moves-id');
       if (!movesID) return;

       const scriptTag = card.previousElementSibling;
       if (!scriptTag) return;

       let movesetDetails;
       try {
           movesetDetails = JSON.parse(scriptTag.textContent);
       } catch (e) {
           console.error('Failed to parse moveset details:', e);
           return;
       }

       const moveBadges = card.querySelectorAll('.move-badge');
       moveBadges.forEach((badge, index) => {
          const moveData = movesetDetails[index];
          if (!moveData) return;

          badge.classList.add(`type-${moveData.type.toLowerCase()}`);

          const categoryText = MOVE_CATEGORY_MAP[moveData.cat] ?? 'Unknown';

          // Check if this move was used (has pp-indicator)
          const ppUsed = badge.getAttribute('data-pp-used');
          const ppUsageHTML = ppUsed ? `
             <div class="move-tooltip-pp-usage">
                <strong>Used ${ppUsed} time${ppUsed !== '1' ? 's' : ''}</strong> in this battle
             </div>
          ` : '';

          const tooltip = document.createElement('div');
          tooltip.className = `move-tooltip type-${moveData.type.toLowerCase()}`;
          tooltip.innerHTML = `
             <div class="move-tooltip-header">
                <span class="move-name">${moveData.name}</span>
                <span class="move-pp">${moveData.pp}/${moveData.maxPP} PP</span>
             </div>

             <div class="move-tooltip-meta">
                <span class="move-type type-${moveData.type.toLowerCase()}">
                   ${moveData.type}
                </span>
                <span class="move-cat cat-${categoryText.toLowerCase()}">
                   ${categoryText}
                </span>
             </div>

             <div class="move-tooltip-stats">
                <span>Power: ${moveData.bp ?? '—'}</span>
                <span>Acc: ${moveData.acc ?? '—'}</span>
             </div>

             <div class="move-tooltip-desc">
                ${moveData.desc}
             </div>

             ${ppUsageHTML}
          `;
          
          const tooltipLayer = document.getElementById('tooltip-layer');
          
          badge.addEventListener('mouseenter', () => {
              tooltipLayer.appendChild(tooltip);
              
              const rect = badge.getBoundingClientRect();
              
              tooltip.style.left = `${rect.left + rect.width / 2}px`;
              tooltip.style.top = `${rect.top - 8}px`;
              
             tooltip.style.opacity = '1';
             tooltip.style.visibility = 'visible';
          });
          
          badge.addEventListener('mouseleave', () => {
             tooltip.style.opacity = '0';
             tooltip.style.visibility = 'hidden';
          });
       });
    });
}
function enhancePokemonTooltips() {
    document.querySelectorAll('.pokemon-card').forEach(card => {
        const tooltip = card.querySelector('.pokemon-tooltip');
        if (!tooltip) return;

        const damageDealt = card.querySelector('.damage-dealt-value')?.textContent;
        const damageTaken = card.querySelector('.damage-taken-value')?.textContent;

        if (damageDealt || damageTaken) {
            // Find the battle performance section or create one
            let perfSection = tooltip.querySelector('.tooltip-section:has(.info-row)');
            if (!perfSection) {
                perfSection = tooltip.querySelector('.tooltip-section');
            }

            if (perfSection && (damageDealt || damageTaken)) {
                const damageStatsHTML = `
          <div class="damage-stats-section">
            ${damageDealt ? `
              <div class="damage-stat-row">
                <span class="damage-stat-label">
                  <i class="fas fa-fire"></i> Total Damage Dealt
                </span>
                <span class="damage-stat-value dealt">${damageDealt}</span>
              </div>
            ` : ''}
            ${damageTaken ? `
              <div class="damage-stat-row">
                <span class="damage-stat-label">
                  <i class="fas fa-shield"></i> Total Damage Taken
                </span>
                <span class="damage-stat-value taken">${damageTaken}</span>
              </div>
            ` : ''}
          </div>
        `;

                perfSection.querySelector('.tooltip-content').insertAdjacentHTML('beforeend', damageStatsHTML);
            }
        }
    });
}
</script>

</body>
</html>