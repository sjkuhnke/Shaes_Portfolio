{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>{{ player_name }} - Player Database</title>
  <meta name="description" content="View all trainers battled by {{ player_name }} in Pokémon Xhenos.">

  <link rel="shortcut icon" href="{% static 'images/logo.ico' %}" type="image/x-icon">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>

<main>
  <article>
    <a href="/xhenos/trainers/" class="back-button">
      <i class="fas fa-arrow-left"></i> Back to Database
    </a>

    <!-- Player Hero -->
    <div class="player-hero">
      <div class="player-header">
        <div class="trainer-avatar">
          <i class="fas fa-user"></i>
        </div>
        <div class="player-details">
          <h1>{{ player_name }}</h1>
          <div class="player-meta">
            <span class="meta-item">
              <i class="fas fa-gamepad"></i>
              Player
            </span>
            <span class="meta-item">
              <i class="fas fa-users"></i>
              {{ trainers|length }} Trainer{{ trainers|length|pluralize }} Battled
            </span>
            {% if last_battle %}
            <span class="meta-item">
              <i class="fas fa-clock"></i>
              Last Battle: {{ last_battle|date:"M d, Y" }}
            </span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    {% if trainers %}
    <!-- Stats Overview -->
    <section class="stats-overview">
      <div class="stats-grid-compact">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-users"></i></div>
          <div class="stat-label">Total Trainers</div>
          <div class="stat-value">{{ trainers|length }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-history"></i></div>
          <div class="stat-label">Total Battles</div>
          <div class="stat-value">{{ total_battles }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-trophy"></i></div>
          <div class="stat-label">Win Rate</div>
          <div class="stat-value">{{ win_percentage }}%</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-heart-broken"></i></div>
          <div class="stat-label">Battles with Deaths</div>
          <div class="stat-value">{{ death_percentage }}%</div>
        </div>
      </div>
    </section>

    <!-- Performance Charts Section with Tabs -->
    <section class="performance-section">
      <h2><i class="fas fa-chart-bar"></i> Performance Statistics</h2>
      
      <!-- Tab Navigation -->
      <div class="chart-tabs">
        <button class="chart-tab active" data-tab="combat">
          <i class="fas fa-crosshairs"></i>
          <span>Combat</span>
        </button>
        <button class="chart-tab" data-tab="survivability">
          <i class="fas fa-heart"></i>
          <span>Survivability</span>
        </button>
        <button class="chart-tab" data-tab="offense">
          <i class="fas fa-fire"></i>
          <span>Offense</span>
        </button>
        <button class="chart-tab" data-tab="strategy">
          <i class="fas fa-chess"></i>
          <span>Strategy</span>
        </button>
      </div>

      <!-- Combat Performance Tab -->
      <div class="chart-tab-content active" id="combat-tab">
        <div class="charts-grid-two">
          <!-- Top Killers Chart -->
          <div class="chart-card">
            <div class="chart-header">
              <h3><i class="fas fa-skull-crossbones"></i> Most Lethal Pokémon</h3>
              <p class="chart-subtitle">Individual Pokémon with highest kill counts</p>
            </div>
            <div class="chart-content">
              {% if top_killers %}
                {% for pokemon in top_killers %}
                <div class="chart-bar-item">
                  <div class="bar-label">
                    <span class="bar-rank">#{{ forloop.counter }}</span>
                    <span class="bar-name">
                      {% if pokemon.nickname %}
                        {{ pokemon.name }} <span class="pokemon-species">({{ pokemon.nickname }})</span>
                      {% else %}
                        {{ pokemon.name }}
                      {% endif %}
                    </span>
                  </div>
                  <div class="bar-container">
                    <div class="bar-fill kills-bar" style="width: 0;" data-max="{{ max_kills }}" data-value="{{ pokemon.kills }}">
                      <span class="bar-value">{{ pokemon.kills }}</span>
                    </div>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <div class="chart-empty">
                  <i class="fas fa-inbox"></i>
                  <p>No kill data recorded</p>
                </div>
              {% endif %}
            </div>
          </div>

          <!-- Most Used Chart -->
          <div class="chart-card">
            <div class="chart-header">
              <h3><i class="fas fa-star"></i> Most Used Species</h3>
              <p class="chart-subtitle">Pokémon species brought most often</p>
            </div>
            <div class="chart-content">
              {% if most_used %}
                {% for pokemon in most_used %}
                <div class="chart-bar-item">
                  <div class="bar-label">
                    <span class="bar-rank">#{{ forloop.counter }}</span>
                    <span class="bar-name">{{ pokemon.name }} line</span>
                  </div>
                  <div class="bar-container">
                    <div class="bar-fill usage-bar" style="width: 0;" data-max="{{ max_usage }}" data-value="{{ pokemon.count }}">
                      <span class="bar-value">{{ pokemon.count }}</span>
                    </div>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <div class="chart-empty">
                  <i class="fas fa-inbox"></i>
                  <p>No usage data available</p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Survivability Tab -->
      <div class="chart-tab-content" id="survivability-tab">
        <div class="charts-grid-two">
          <!-- Most Killed Species Chart -->
          <div class="chart-card">
            <div class="chart-header">
              <h3><i class="fas fa-heart-crack"></i> Most Lost Species</h3>
              <p class="chart-subtitle">Pokémon species that fainted most often</p>
            </div>
            <div class="chart-content">
              {% if most_killed %}
                {% for pokemon in most_killed %}
                <div class="chart-bar-item">
                  <div class="bar-label">
                    <span class="bar-rank">#{{ forloop.counter }}</span>
                    <span class="bar-name">{{ pokemon.name }} line</span>
                  </div>
                  <div class="bar-container">
                    <div class="bar-fill deaths-bar" style="width: 0;" data-max="{{ max_deaths }}" data-value="{{ pokemon.count }}">
                      <span class="bar-value">{{ pokemon.count }}</span>
                    </div>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <div class="chart-empty">
                  <i class="fas fa-inbox"></i>
                  <p>No death data recorded</p>
                </div>
              {% endif %}
            </div>
          </div>

          <!-- Most Damage Taken (Sponges) Chart -->
          <div class="chart-card">
            <div class="chart-header">
              <h3><i class="fas fa-shield"></i> Biggest Sponges</h3>
              <p class="chart-subtitle">Pokémon that absorbed the most total damage</p>
            </div>
            <div class="chart-content">
              {% if most_damage_taken %}
                {% for pokemon in most_damage_taken %}
                <div class="chart-bar-item">
                  <div class="bar-label">
                    <span class="bar-rank">#{{ forloop.counter }}</span>
                    <span class="bar-name">
                      {% if pokemon.nickname %}
                        {{ pokemon.name }} <span class="pokemon-species">({{ pokemon.nickname }})</span>
                      {% else %}
                        {{ pokemon.name }}
                      {% endif %}
                    </span>
                  </div>
                  <div class="bar-container">
                    <div class="bar-fill sponge-bar" style="width: 0;" data-max="{{ max_damage_taken_most }}" data-value="{{ pokemon.damage }}">
                      <span class="bar-value">{{ pokemon.damage }}%</span>
                    </div>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <div class="chart-empty">
                  <i class="fas fa-inbox"></i>
                  <p>No damage taken data recorded</p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Offense Tab -->
      <div class="chart-tab-content" id="offense-tab">
        <div class="charts-grid-two">
          <!-- Most Damage Dealt Chart -->
          <div class="chart-card">
            <div class="chart-header">
              <h3><i class="fas fa-fist-raised"></i> Highest Damage Dealers</h3>
              <p class="chart-subtitle">Individual Pokémon dealing the most total damage</p>
            </div>
            <div class="chart-content">
              {% if most_damage_dealt %}
                {% for pokemon in most_damage_dealt %}
                <div class="chart-bar-item">
                  <div class="bar-label">
                    <span class="bar-rank">#{{ forloop.counter }}</span>
                    <span class="bar-name">
                      {% if pokemon.nickname %}
                        {{ pokemon.name }} <span class="pokemon-species">({{ pokemon.nickname }})</span>
                      {% else %}
                        {{ pokemon.name }}
                      {% endif %}
                    </span>
                  </div>
                  <div class="bar-container">
                    <div class="bar-fill damage-dealt-bar" style="width: 0;" data-max="{{ max_damage_dealt }}" data-value="{{ pokemon.damage }}">
                      <span class="bar-value">{{ pokemon.damage }}%</span>
                    </div>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <div class="chart-empty">
                  <i class="fas fa-inbox"></i>
                  <p>No damage dealt data recorded</p>
                </div>
              {% endif %}
            </div>
          </div>

          <!-- Most Used Moves Chart -->
          <div class="chart-card">
            <div class="chart-header">
              <h3><i class="fas fa-magic"></i> Most Used Moves</h3>
              <p class="chart-subtitle">Moves used most frequently across all battles</p>
            </div>
            <div class="chart-content">
              {% if most_used_moves %}
                {% for move in most_used_moves %}
                <div class="chart-bar-item">
                  <div class="bar-label">
                    <span class="bar-rank">#{{ forloop.counter }}</span>
                    <span class="bar-name">{{ move.name }}</span>
                  </div>
                  <div class="bar-container">
                    <div class="bar-fill move-usage-bar" style="width: 0;" data-max="{{ max_move_usage }}" data-value="{{ move.count }}">
                      <span class="bar-value">{{ move.count }} PP</span>
                    </div>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <div class="chart-empty">
                  <i class="fas fa-inbox"></i>
                  <p>No move usage data recorded</p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Strategy Tab -->
      <div class="chart-tab-content" id="strategy-tab">
        <div class="charts-grid-two">
          <!-- Most Active Chart -->
          <div class="chart-card">
            <div class="chart-header">
              <h3><i class="fas fa-bolt"></i> Most Active Species</h3>
              <p class="chart-subtitle">Pokémon with most turns taken and switches made</p>
            </div>
            <div class="chart-content">
              {% if most_active %}
                {% for pokemon in most_active %}
                <div class="chart-bar-item">
                  <div class="bar-label">
                    <span class="bar-rank">#{{ forloop.counter }}</span>
                    <span class="bar-name" title="Avg: {{ pokemon.avg_turns }} turns, {{ pokemon.avg_switches }} switches per battle">{{ pokemon.name }} line</span>
                  </div>
                  <div class="bar-container-wrapper">
                    <div class="bar-segment">
                      <div class="bar-container">
                        <div class="bar-fill turns-bar" style="width: 0;" data-max="{{ max_turns }}" data-value="{{ pokemon.turns }}">
                          <span class="bar-value">{{ pokemon.turns }}</span>
                        </div>
                      </div>
                      <span class="bar-segment-label">turns</span>
                    </div>
                    <div class="bar-segment">
                      <div class="bar-container">
                        <div class="bar-fill switches-bar" style="width: 0;" data-max="{{ max_switches }}" data-value="{{ pokemon.switch_ins }}">
                          <span class="bar-value">{{ pokemon.switch_ins }}</span>
                        </div>
                      </div>
                      <span class="bar-segment-label">switches</span>
                    </div>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <div class="chart-empty">
                  <i class="fas fa-inbox"></i>
                  <p>No activity data recorded</p>
                </div>
              {% endif %}
            </div>
          </div>

          <!-- Least Damage Taken Chart -->
          <div class="chart-card">
            <div class="chart-header">
              <h3><i class="fas fa-shield-alt"></i> Most Resilient</h3>
              <p class="chart-subtitle">Active Pokémon that took the least damage</p>
            </div>
            <div class="chart-content">
              {% if least_damage_taken %}
                {% for pokemon in least_damage_taken %}
                <div class="chart-bar-item">
                  <div class="bar-label">
                    <span class="bar-rank">#{{ forloop.counter }}</span>
                    <span class="bar-name">
                      {% if pokemon.nickname %}
                        {{ pokemon.name }} <span class="pokemon-species">({{ pokemon.nickname }})</span>
                      {% else %}
                        {{ pokemon.name }}
                      {% endif %}
                    </span>
                  </div>
                  <div class="bar-container">
                    <div class="bar-fill resilient-bar" style="width: 0;" data-max="{{ max_damage_taken_least }}" data-value="{{ pokemon.damage }}">
                      <span class="bar-value">{{ pokemon.damage }}%</span>
                    </div>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <div class="chart-empty">
                  <i class="fas fa-inbox"></i>
                  <p>No damage taken data recorded</p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Trainers List -->
    <section class="trainers-section">
      <h2><i class="fas fa-users"></i> Trainers Battled</h2>

      <div class="trainers-grid">
        {% for trainer in trainers %}
        <div class="trainer-card{% if trainer.has_deaths %} has-deaths{% endif %}" onclick="window.location.href='/xhenos/trainers/{{ trainer.trainer_name|urlencode }}/'">
          <div class="trainer-card-header">
            <div class="trainer-icon">
              <i class="fas fa-user-ninja"></i>
            </div>
            <div class="trainer-info">
              <h3>{{ trainer.trainer_name }}</h3>
              <div class="trainer-battles">
                <i class="fas fa-swords"></i>
                {{ trainer.battle_count }} battle{{ trainer.battle_count|pluralize }}
              </div>
            </div>
          </div>

          <!-- Battle Badges -->
          <div class="trainer-badges">
            {% if trainer.has_deaths %}
            <div class="trainer-badge death-badge">
              <i class="fas fa-skull"></i>
              <span>Deaths</span>
            </div>
            {% endif %}
            
            {% if trainer.highest_difficulty == "1" %}
            <div class="trainer-badge difficulty-badge difficulty-normal">
              <i class="fas fa-circle"></i>
              <span>Normal</span>
            </div>
            {% elif trainer.highest_difficulty == "3" %}
            <div class="trainer-badge difficulty-badge difficulty-extreme">
              <i class="fas fa-skull"></i>
              <span>Extreme</span>
            </div>
            {% else %}
            <div class="trainer-badge difficulty-badge difficulty-hard">
              <i class="fas fa-fire"></i>
              <span>Hard</span>
            </div>
            {% endif %}
          </div>

          <div class="trainer-stats">
            <div class="stat-item">
              <div class="stat-label">Last Battle</div>
              <div class="stat-value">{{ trainer.last_battle|date:"M d" }}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Battles</div>
              <div class="stat-value">{{ trainer.battle_count }}</div>
            </div>
          </div>

          <div class="view-trainer-btn">
            <span>View Details</span>
            <i class="fas fa-arrow-right"></i>
          </div>
        </div>
        {% endfor %}
      </div>
    </section>
    {% else %}
    <div class="no-trainers">
      <i class="fas fa-inbox"></i>
      <h3>No Trainers Found</h3>
      <p>No battle records found for {{ player_name }}.</p>
    </div>
    {% endif %}

  </article>
</main>

<script>
// Tab switching functionality
document.addEventListener('DOMContentLoaded', function() {
  const tabButtons = document.querySelectorAll('.chart-tab');
  const tabContents = document.querySelectorAll('.chart-tab-content');

  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      const targetTab = button.dataset.tab;

      // Remove active class from all tabs and contents
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));

      // Add active class to clicked tab and corresponding content
      button.classList.add('active');
      document.getElementById(`${targetTab}-tab`).classList.add('active');

      // Re-animate bars in the newly visible tab
      animateBarsInTab(targetTab);
    });
  });

  // Initial animation for the first (active) tab
  animateBarsInTab('combat');
});

// Animate bars in a specific tab
function animateBarsInTab(tabName) {
  const tabContent = document.getElementById(`${tabName}-tab`);
  const bars = tabContent.querySelectorAll('.bar-fill');
  
  bars.forEach((bar, index) => {
    const maxValue = parseFloat(bar.dataset.max);
    const barValue = parseFloat(bar.dataset.value);
    const percentage = (barValue / maxValue) * 100;
    
    // Reset width
    bar.style.width = '0%';
    
    // Animate after a slight delay
    setTimeout(() => {
      bar.style.width = percentage + '%';
    }, 100 + (index * 50));
  });
}
</script>

</body>
</html>